# 日志配置

## 默认日志框架

Spring Boot 默认使用 **Logback** 作为日志框架，同时也支持 **Log4j2** 和 **Java Util Logging**。
 Logback 是 Spring Boot 的首选日志实现，具有高性能、灵活的配置和良好的社区支持。

**默认日志行为**

- **控制台输出**：默认将日志输出到控制台。
- **日志级别**：默认日志级别为 `INFO`。
- **日志格式**：默认格式包含时间戳、日志级别、线程名、类名和日志内容。
- **日志文件**：默认不生成日志文件，除非手动配置。

## 日志框架分层结构

### 日志门面（抽象层）

日志门面是统一的日志接口，屏蔽底层实现细节，常见的日志门面包括：

- **SLF4J（Simple Logging Facade for Java）**：Spring Boot 默认使用的日志门面。
- **JCL（Jakarta Commons Logging）**：Apache 提供的旧版日志门面。
- **JUL（Java Util Logging）**：Java 原生日志框架，通过 `java.util.logging` 包提供。

### 日志实现（具体实现）

日志实现是实际的日志处理库，常见的实现包括：

- **Logback**：Spring Boot 默认使用的日志实现，由 SLF4J 的作者开发，性能优秀且配置灵活。
- **Log4j**：Apache 提供的经典日志框架，但已不再维护（建议使用 Log4j2）。
- **Log4j2**：Log4j 的升级版，支持异步日志、配置热更新等特性。
- **JUL**：Java 原生日志实现，功能较弱但无需额外依赖。

### 默认日志体系

Spring Boot 默认使用 **SLF4J + Logback** 的组合，其依赖关系如下：

```xml
<!-- Spring Boot Starter 默认包含 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter</artifactId>
    <exclusions>
        <!-- 排除默认 Logback -->
        <exclusion>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-logging</artifactId>
        </exclusion>
    </exclusions>
</dependency>

<!-- 默认包含的日志实现 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-logging</artifactId>
    <scope>compile</scope>
</dependency>
```

### 常见日志门面与实现的绑定关系

| **日志门面** | **常见实现**         | **绑定方式**                                                 |
| ------------ | -------------------- | ------------------------------------------------------------ |
| **SLF4J**    | Logback、Log4j2、JUL | 通过 `slf4j-api` 与具体实现绑定（如 `logback-classic`、`log4j-slf4j-impl`） |
| **JCL**      | Log4j、JUL           | 通过 `commons-logging` 与具体实现绑定（如 `log4j-jcl`）      |
| **JUL**      | 无                   | Java 原生实现，无需绑定                                      |

## 日志配置

Spring Boot 提供多种方式配置日志，包括：

- **`application.properties` / `application.yml`**（推荐）
- **`logback-spring.xml` / `log4j2-spring.xml`**（适用于复杂配置）
- **系统环境变量**（适用于动态调整）

###  使用 `application.properties` 配置

```
# 设置日志级别
logging.level.root=INFO
logging.level.com.example=DEBUG

# 设置日志输出文件
logging.file.name=logs/app.log

# 设置日志文件最大大小（触发滚动）
logging.file.max-size=10MB

# 设置日志文件保留天数
logging.file.max-history=7

# 设置日志格式
logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n
```

### 使用 `application.yml` 配置

```yaml
logging:
  level:
    root: INFO
    com.example: DEBUG
  file:
    name: logs/app.log
    max-size: 10MB
    max-history: 7
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
```

### 使用 `logback-spring.xml` 配置

适用于复杂场景（如多文件输出、异步日志、自定义格式）。

```xml
<configuration>
    <!-- 控制台输出 -->
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>

    <!-- 文件输出 -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/app.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <!-- 每天滚动 -->
            <fileNamePattern>logs/app.%d{yyyy-MM-dd}.log</fileNamePattern>
            <!-- 保留7天 -->
            <maxHistory>7</maxHistory>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>

    <!-- 根日志级别 -->
    <root level="INFO">
        <appender-ref ref="STDOUT" />
        <appender-ref ref="FILE" />
    </root>

    <!-- 包级别日志 -->
    <logger name="com.example" level="DEBUG" />
</configuration>
```

## 日志级别

Spring Boot 支持的日志级别（从高到低）：

```
ERROR > WARN > INFO > DEBUG > TRACE
```

### **设置全局日志级别**

```
# application.properties
logging.level.root=INFO
```

### 设置包级别日志级别

```
# application.properties
logging.level.com.example=DEBUG
logging.level.org.springframework=INFO
```

### 动态调整日志级别

```
POST /actuator/loggers/com.example
{
  "configuredLevel": "DEBUG"
}
```

## 日志输出

### 控制台格式

```
# application.properties
logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n
```

### 文件格式

```
# application.properties
logging.pattern.file=%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n
```

### 常用格式化参数

| **参数**      | **说明**                      |
| ------------- | ----------------------------- |
| `%d`          | 日期                          |
| `%thread`     | 线程名                        |
| `%-5level`    | 日志级别（左对齐，5字符宽度） |
| `%logger{36}` | 类名（最大36字符）            |
| `%msg`        | 日志内容                      |
| `%n`          | 换行                          |

## 日志实现切换

 Spring Boot 默认使用 **Logback** 作为日志实现，但支持切换为 **Log4j2** 或 **Java Util Logging（JUL）**。选择不同实现的典型场景：

- **Logback**：默认实现，轻量、高性能，适合大多数项目。
- **Log4j2**：需要异步日志、结构化日志、动态配置热更新。
- **JUL**：减少依赖项，使用 Java 原生日志框架。

 **排除默认 Logback**

```
<!-- Maven 示例 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter</artifactId>
    <exclusions>
        <!-- 排除默认 Logback -->
        <exclusion>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-logging</artifactId>
        </exclusion>
    </exclusions>
</dependency>
```

**添加 Log4j2 依赖**

```
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-log4j2</artifactId>
</dependency>
```

**配置 Log4j2**

创建 `log4j2-spring.xml` 文件（推荐）：

```
<?xml version="1.0" encoding="UTF-8"?>
<Configuration status="INFO">
    <Appenders>
        <!-- 控制台输出 -->
        <Console name="Console" target="SYSTEM_OUT">
            <PatternLayout pattern="%d{yyyy-MM-dd HH:mm:ss} [%t] %-5level %logger{36} - %msg%n"/>
        </Console>
        <!-- 文件输出 -->
        <RollingFile name="File" fileName="logs/app.log" filePattern="logs/app.%d{yyyy-MM-dd}.log">
            <PatternLayout pattern="%d{yyyy-MM-dd HH:mm:ss} [%t] %-5level %logger{36} - %msg%n"/>
            <Policies>
                <TimeBasedTriggeringPolicy interval="1" modulate="true"/>
                <SizeBasedTriggeringPolicy size="10MB"/>
            </Policies>
            <DefaultRolloverStrategy max="7"/>
        </RollingFile>
    </Appenders>
    <Loggers>
        <Root level="INFO">
            <AppenderRef ref="Console"/>
            <AppenderRef ref="File"/>
        </Root>
        <Logger name="com.example" level="DEBUG"/>
    </Loggers>
</Configuration>
```

## Logback 的使用

在开始编写代码之前，确保 `pom.xml` 中已包含 SLF4J 和 Logback 的依赖，一般在 spring-boot-starter 中已经引入。

### 获取日志记录器（Logger）

使用类名作为日志记录器名称（推荐）：

```
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class MyService {

    // 通常使用类名作为 logger 名称
    private static final Logger logger = LoggerFactory.getLogger(MyService.class);

    public void doSomething() {
        logger.info("This is an info message.");
    }
}
```

使用自定义名称（适用于非类上下文）

```
private static final Logger logger = LoggerFactory.getLogger("MyCustomLogger");
```

------

### 记录日志

SLF4J 提供了多种日志级别：`trace`, `debug`, `info`, `warn`, `error`，根据日志的重要性选择合适的级别。

**基本日志记录**：

```
logger.trace("Trace message");
logger.debug("Debug message");
logger.info("Info message");
logger.warn("Warning message");
logger.error("Error message");
```

**使用占位符**（推荐方式）

避免字符串拼接，提升性能和可读性：

```
String name = "Alice";
int age = 30;
logger.info("User: {}, Age: {}", name, age);
```

### 记录异常

```
try {
    // some code that may throw an exception
} catch (Exception e) {
    logger.error("An error occurred", e);
}
```

------

### 日志级别控制（运行时动态判断）

为了优化性能，可以在执行复杂操作前判断日志级别是否启用：

```
if (logger.isDebugEnabled()) {
    logger.debug("Debug message: " + expensiveOperation());
}
```

------

### MDC（Mapped Diagnostic Context）

MDC 用于在日志中添加上下文信息，如用户ID、请求ID等，便于日志追踪。

**设置 MDC 数据**

```
import org.slf4j.MDC;

public void processRequest(String userId) {
    MDC.put("userId", userId);
    logger.info("Processing request for user {}", userId);
    MDC.clear();  // 处理完成后清除
}
```

### **配置日志格式以显示 MDC**

在 `logback-spring.xml` 中添加 `%X{userId}`：

```
<encoder>
    <pattern>%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %X{userId} - %msg%n</pattern>
</encoder>
```

#### 异步日志（提升性能）

Logback 支持异步日志，通过 `AsyncAppender` 实现，减少日志写入对主线程的影响。

配置 `AsyncAppender`（在 `logback-spring.xml` 中）：

```
<appender name="ASYNC" class="ch.qos.logback.classic.AsyncAppender">
    <appender-ref ref="STDOUT"/>
</appender>

<root level="info">
    <appender-ref ref="ASYNC"/>
</root>
```

------

#### 结构化日志（JSON 格式）

结构化日志便于日志分析工具（如 ELK、Splunk）解析。

配置 JSON 日志格式：

```
<appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
    <encoder>
        <pattern>
            {
                "timestamp": "%d{yyyy-MM-dd HH:mm:ss}",
                "level": "%level",
                "thread": "%thread",
                "logger": "%logger",
                "message": "%msg"
            }
        </pattern>
    </encoder>
</appender>
```

------

#### 最佳实践

| **场景**              | **建议**                                                     |
| --------------------- | ------------------------------------------------------------ |
| **日志命名**          | 使用类名作为日志记录器名，便于定位日志来源。                 |
| **避免字符串拼接**    | 使用 `{}` 占位符，提升性能，避免不必要的字符串拼接。         |
| **日志级别判断**      | 在执行复杂操作前使用 `isDebugEnabled()` 等判断，避免浪费资源。 |
| **上下文日志（MDC）** | 在请求处理中设置 MDC，如用户ID、请求ID，便于日志追踪。       |
| **异步日志**          | 高并发场景下使用 `AsyncAppender` 提升性能。                  |
| **结构化日志**        | 使用 JSON 格式输出日志，便于日志分析工具（如 ELK）解析。     |

#### 总结

- **日志调用基于 SLF4J API**，与具体实现（Logback、Log4j2）解耦。
- **获取 Logger 实例** 推荐使用 `LoggerFactory.getLogger(Class)`。
- **使用占位符** 避免字符串拼接，提升性能。
- **MDC** 用于记录上下文信息，便于日志追踪。
- **日志级别控制** 可通过 `isDebugEnabled()` 等方法优化性能。
- **异步日志** 和 **结构化日志** 是提升日志处理效率和可维护性的关键。